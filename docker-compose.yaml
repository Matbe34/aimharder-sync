version: '3.8'

services:
  # Interactive service for manual commands and initial auth
  aimharder-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aimharder-sync
    restart: "no"
    environment:
      # Aimharder credentials (REQUIRED)
      - AIMHARDER_EMAIL=${AIMHARDER_EMAIL}
      - AIMHARDER_PASSWORD=${AIMHARDER_PASSWORD}
      
      # Aimharder box configuration
      - AIMHARDER_BOX_NAME=${AIMHARDER_BOX_NAME:-valhallatrainingcamp}
      - AIMHARDER_BOX_ID=${AIMHARDER_BOX_ID:-9818}
      - AIMHARDER_FAMILY_ID=${AIMHARDER_FAMILY_ID:-}
      - AIMHARDER_USER_ID=${AIMHARDER_USER_ID:-}
      
      # Strava OAuth credentials (REQUIRED for Strava sync)
      - STRAVA_CLIENT_ID=${STRAVA_CLIENT_ID}
      - STRAVA_CLIENT_SECRET=${STRAVA_CLIENT_SECRET}
      
      # Timezone (Spain for Aimharder)
      - TZ=Europe/Madrid
    volumes:
      # Persist data (tokens, sync history, TCX files)
      - aimharder-data:/data
    ports:
      # OAuth callback port (required for initial Strava auth)
      - "8080:8080"
    # Override default command if needed
    # command: ["sync", "--days", "7"]

  # Scheduler service - checks every minute for new workouts
  aimharder-scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aimharder-scheduler
    restart: unless-stopped
    environment:
      # Aimharder credentials (REQUIRED)
      - AIMHARDER_EMAIL=${AIMHARDER_EMAIL}
      - AIMHARDER_PASSWORD=${AIMHARDER_PASSWORD}
      - AIMHARDER_BOX_NAME=${AIMHARDER_BOX_NAME:-valhallatrainingcamp}
      - AIMHARDER_BOX_ID=${AIMHARDER_BOX_ID:-9818}
      - AIMHARDER_FAMILY_ID=${AIMHARDER_FAMILY_ID:-}
      - AIMHARDER_USER_ID=${AIMHARDER_USER_ID:-}
      
      # Strava OAuth credentials (REQUIRED for Strava sync)
      - STRAVA_CLIENT_ID=${STRAVA_CLIENT_ID}
      - STRAVA_CLIENT_SECRET=${STRAVA_CLIENT_SECRET}
      
      # Timezone
      - TZ=Europe/Madrid
      
      # Scheduler configuration
      - CHECK_INTERVAL=${CHECK_INTERVAL:-60}      # Check every 60 seconds
      - SYNC_DAYS=${SYNC_DAYS:-1}                 # Look back 1 day
      - QUIET_HOURS_START=${QUIET_HOURS_START:-0} # Quiet hours start (0=disabled)
      - QUIET_HOURS_END=${QUIET_HOURS_END:-0}     # Quiet hours end (0=disabled)
    volumes:
      - aimharder-data:/data
    entrypoint: ["/bin/sh", "-c"]
    command: ["/app/scheduler.sh"]
    profiles:
      - scheduler  # Only starts with: docker-compose --profile scheduler up

  # Webhook server - trigger syncs from phone widgets or automation
  aimharder-webhook:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aimharder-webhook
    restart: unless-stopped
    environment:
      # Aimharder credentials (REQUIRED)
      - AIMHARDER_EMAIL=${AIMHARDER_EMAIL}
      - AIMHARDER_PASSWORD=${AIMHARDER_PASSWORD}
      - AIMHARDER_BOX_NAME=${AIMHARDER_BOX_NAME:-valhallatrainingcamp}
      - AIMHARDER_BOX_ID=${AIMHARDER_BOX_ID:-9818}
      - AIMHARDER_FAMILY_ID=${AIMHARDER_FAMILY_ID:-}
      - AIMHARDER_USER_ID=${AIMHARDER_USER_ID:-}
      
      # Strava OAuth credentials (REQUIRED for Strava sync)
      - STRAVA_CLIENT_ID=${STRAVA_CLIENT_ID}
      - STRAVA_CLIENT_SECRET=${STRAVA_CLIENT_SECRET}
      
      # Timezone
      - TZ=Europe/Madrid
      
      # Webhook configuration
      - WEBHOOK_PORT=${WEBHOOK_PORT:-8080}
      - WEBHOOK_TOKEN=${WEBHOOK_TOKEN:-}  # Set this for security!
    volumes:
      - aimharder-data:/data
    ports:
      - "${WEBHOOK_PORT:-8080}:8080"
    entrypoint: ["/app/aimharder-sync"]
    command: ["webhook", "--port", "8080", "--token", "${WEBHOOK_TOKEN:-}"]
    profiles:
      - webhook  # Only starts with: docker-compose --profile webhook up

volumes:
  aimharder-data:
    driver: local
